# PR Reviewer Assignment Service (version: 1.0.0)

Реализация тестового задания на стажировку в Авито Тех.

### Как проверяющим протестировать мою работу?

1. Создайте .env файл и заполните его переменными окружения. Пример переменных окружения вы можете взять в файле
   .env.example
2. Запустите сервис командой. В файлах уже настроен маппинг портов, убедитесь что Go-приложение стартует не верном
   порте.

```bash
   docker-compose --file docker-compose.dev.yaml up
```

### Вопросы

По мере разработки данной системы я задавался следующими вопросами:

1. Может ли пользователь состоять в нескольких командах сразу? Я посчитал, что нет. Иначе следовало бы создавать связь
   многие ко многим в схеме базы данных и делать пользователя на уровне домена независимой структурой от команды.
2. Насколько нужно важна атомарность методов в этой системе? Атомарные проверки во многих местах можно опустить из-за
   объема данных и RPS (до 20 команд и до 200 пользователей, 5 RPS). Атомарные методы важны только в местах, где нам
   требуется условие "Все, или ничего" - например, при создании команд и пользователей.
3. Может ли автор быть ревьюером своего же ПР? - Нет.
4. В OpenAPI есть токены, но нет эндпоинтов - как быть с авторизацией? Генерацию токенов опустить, добавить миддлвары
   для проверки токенов и роли, токены захаркодить и выдать проверяющим. По ТЗ эндпоинты лишь должны быть защищены,
   эндпоинтов для генерации или обновлении токен я не нашел. Исходя из подобной инфо из ТЗ я принял такое решение.
    1. Как проверяющим пройти авторизацию? Токены захардкожены. Тип токенов - Bearer.
        - Как админ: ``Authorization: Bearer hardcoded-admin-token``
        - Как пользователь: ``Authorization: Bearer hardcoded-user-token``

### Какие дополнительные задания я выполнил?

1. Настроил конфигурацию линтера - в файле golangci.yml. Инструкция по конфигурации была взята
   здесь: https://golangci-lint.run/docs/configuration/file/
2. С помощью библиотеки testcontainers и goose для миграций написал интеграционные тесты с реальной базой данных.
3. Провел нагрузочное тестирование:
    - Данные: 26 команд, 220 пользователей.
    - Утилита для теста: hey
    - Параллельных запросов - 5. Всего запросов - 50 (RPS = 5)
    - Итоги:
        1. Получение команд:
            - Команда для теста:
              ```hey -n 50 -q 5 \ 
                 -H "Authorization: Bearer hardcoded-admin-token" \ 
                 "http://localhost:8080/team/get?team_name=payments6"
              ```
            - Общее время выполнения: 0.0361 сек
            - Среднее время ответа: 3.1 мс
            - Максимальное время ответа: 27.1 мс
            - Все запросы успешные (100%)
        2. Получение всех пулл реквестов, где пользователь является ревьюером:
            - Команда для теста:
              ``` hey -n 50 -c 5 \ 
                  -H "Authorization: Bearer hardcoded-admin-token" \ 
                  "http://localhost:8080/users/getReview?user_id=dfaf3068-4bc8-40f1-8d6c-8fe38bd2acd5"
              ```
            - Общее время выполнения: 0.05 сек
            - Среднее время ответа: 4.7 мс
            - Максимальное время ответа: 29.7 мс
            - Все запросы успешные (100%)
        3. Выставление пользователю статуса (активен/не активен):
            - Команда для теста:
              ``` hey -n 50 -c 5 \        
                  -m POST \
                  -H "Authorization: Bearer hardcoded-admin-token" \
                  -H "Content-Type: application/json" \
                  -d '{"user_id": "06383dd2-834b-42a3-8a23-4ccdabcc4c8d", "is_active": false}' \
                  "http://localhost:8080/users/setIsActive"
              ```
            - Общее время выполнения: 0.058 сек
            - Среднее время ответа: 5.3 мс
            - Максимальное время ответа: 40.8 мс
            - Все запросы успешные: (100%)
        4. Выставление ПР стаутса MERGED:
            - Команда для теста:
              ```hey -n 50 -c 5 -H "Authorization: Bearer hardcoded-admin-token" \
                 -m POST \
                 -H "Authorization: Bearer hardcoded-admin-token" \
                 -H "Content-Type: application/json" \
                 -d '{"pull_request_id":"c3c08242-d406-44ee-8a17-11d7c0c98a9f"}' \
                 "http://localhost:8080/pullRequest/merge"
              ```
            - Общее время выполнения: 0.045 сек
            - Среднее время ответа: 4.0 мс
            - Максимальное время ответа: 25.9 мс
            - Все запросы успешные: (100%)

### Мои замечания по ТЗ

1. Названия ресурсов (pullRequest,team) - почему-то не во множественном числе, в отличии от остальных мест. Я бы делал
   ресурсы во множественном числе
