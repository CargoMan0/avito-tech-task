# PR Reviewer Assignment Service (version: 1.0.0)

Реализация тестового задания на стажировку в Авито Тех.

### Как проверяющим протестировать мою работу?

1. Скопируйте репозиторий на локальную машину.
2. Запустите сервис командой. В файлах уже настроен маппинг портов. По умолчанию все env параметры будут соответствовать
   параметрам в .env.example

```bash
   docker-compose up
```

### Вопросы

По мере разработки данной системы я задавался следующими вопросами:

1. Может ли пользователь состоять в нескольких командах сразу? Я посчитал, что нет. Иначе следовало бы создавать связь
   многие ко многим в схеме базы данных и делать пользователя на уровне домена независимой структурой от команды.
2. Является ли пользователь самостоятельной сущностью в рамках данной системы? Исходя из OpenAPI, я посчитал, что нет.
3. Насколько нужно важна атомарность методов в этой системе? Атомарные проверки во многих местах можно опустить из-за
   объема данных и RPS (до 20 команд и до 200 пользователей, 5 RPS). Атомарные методы важны только в местах, где нам
   требуется условие "Все, или ничего" - например, при создании команд и пользователей.
4. Может ли автор быть ревьюером своего же ПР? - Нет.
5. OpenAPI есть токены, но нет эндпоинтов - как быть с авторизацией? Генерацию токенов сделать, но токены будут
   вечными, добавить миддлвары для проверки токенов и роли, токены выдать проверяющим. По ТЗ эндпоинты
   лишь должны быть защищены, эндпоинтов для генерации или обновлении токен я не нашел. Исходя из подобной инфо из ТЗ я
   принял такое решение. Прошу учесть, что я прекрасно понимаю, что так делать - плохо. Нужно сделать эндпоинт, где
   можно генерировать JWT токен и подписывать его на стороне сервиса. Однако, исходя из OpenAPI это не понятно. Только
   один эндпоинт имеет явно возвращаемый код 401, хотя защищенными обозначены практически все!
6. А нужно ли соблюдение прав между разными пользователями? Т.е - может ли пользователь X получить доступ к ресурсу,
   которым в теории владее пользователь Y? В данной системе я опустил этот вопрос, токены здесь не обозначают конкретную
   сущность, они лишь отображают уровень прав.
    1. Как проверяющим пройти авторизацию? . Тип токенов - Bearer. Токены подписаны секретной фразой из .env.example
        - Как админ:
          ``Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4ifQ.H8m41meCDWkRYIcOIjy0s2yN6ZNuprR-Fs5IO1z1Nl8`` *
          или сгенерируйте самостоятельно.
        - Как пользователь:
          ``Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciJ9.d8mUijDTy0HD5_XzE6s-pNxHmfun96QTa94TMZifvx0`` *
          или сгенерируйте самостоятельно.

### Объяснение некоторых моих решений

1. В системе используется UUID в качестве идентификатора, чтобы увеличить селективность индексов, создающихся с Primary
   Key, тем самым ускоряя поиск по таблицам.
2. Я не использую DEFAULT в таблицах PostgreSQL, так как придерживаюсь в этой системе философии, что задача хранилища -
   хранить. Оно не должно само создавать значения без ведома системы. Заполнением хранилища занимается слой
   репозиториев.

### Какие дополнительные задания я выполнил?

1. Настроил конфигурацию линтера - в файле golangci.yml. Инструкция по конфигурации была взята
   здесь: https://golangci-lint.run/docs/configuration/file/
2. С помощью библиотеки testcontainers и goose для миграций написал интеграционные тесты с реальной базой данных.
3. Провел нагрузочное тестирование:
    - Данные: 26 команд, 220 пользователей.
    - Утилита для теста: hey
    - Параллельных запросов - 5. Всего запросов - 50 (RPS = 5)
    - Итоги:
        1. Получение команд:
            - Команда для теста:
              ```hey -n 50 -q 5 \ 
                 -H "Authorization: Bearer hardcoded-admin-token" \ 
                 "http://localhost:8080/team/get?team_name=payments6"
              ```
            - Общее время выполнения: 0.0361 сек
            - Среднее время ответа: 3.1 мс
            - Максимальное время ответа: 27.1 мс
            - Все запросы успешные (100%)
        2. Получение всех пулл реквестов, где пользователь является ревьюером:
            - Команда для теста:
              ``` hey -n 50 -c 5 \ 
                  -H "Authorization: Bearer hardcoded-admin-token" \ 
                  "http://localhost:8080/users/getReview?user_id=dfaf3068-4bc8-40f1-8d6c-8fe38bd2acd5"
              ```
            - Общее время выполнения: 0.05 сек
            - Среднее время ответа: 4.7 мс
            - Максимальное время ответа: 29.7 мс
            - Все запросы успешные (100%)
        3. Выставление пользователю статуса (активен/не активен):
            - Команда для теста:
              ``` hey -n 50 -c 5 \        
                  -m POST \
                  -H "Authorization: Bearer hardcoded-admin-token" \
                  -H "Content-Type: application/json" \
                  -d '{"user_id": "06383dd2-834b-42a3-8a23-4ccdabcc4c8d", "is_active": false}' \
                  "http://localhost:8080/users/setIsActive"
              ```
            - Общее время выполнения: 0.058 сек
            - Среднее время ответа: 5.3 мс
            - Максимальное время ответа: 40.8 мс
            - Все запросы успешные: (100%)
        4. Выставление ПР стаутса MERGED:
            - Команда для теста:
              ```hey -n 50 -c 5 -H "Authorization: Bearer hardcoded-admin-token" \
                 -m POST \
                 -H "Authorization: Bearer hardcoded-admin-token" \
                 -H "Content-Type: application/json" \
                 -d '{"pull_request_id":"c3c08242-d406-44ee-8a17-11d7c0c98a9f"}' \
                 "http://localhost:8080/pullRequest/merge"
              ```
            - Общее время выполнения: 0.045 сек
            - Среднее время ответа: 4.0 мс
            - Максимальное время ответа: 25.9 мс
            - Все запросы успешные: (100%)

### Заключение и мои замечания по ТЗ

1. Названия ресурсов (pullRequest,team) - почему-то не во множественном числе, в отличии от остальных мест. Я бы делал
   ресурсы во множественном числе
2. Пожалуйста, пишите больше информации про авторизацию. Все эндпоинты должны возвращать ошибку 401 в случае провала
   авторизации. В этом месте не очень хорошо сделано ТЗ и в частности OpenAPI.

Исходя из всех вышеперечисленных вопросов и замечаний, прошу Вас в следующие разы делать более детальное техническое
задание. Никто не любит не полных ТЗ в рабочих задачах, к сожалению, в выполнении данной задачи у меня не было
возможности сесть и на груминге обсудить все вышестоящие вопросы. С точки зрения технических требований, описанных на
вашем GitHub и OpenAPI, данная система на 100% соответствует заявленным вами требованиям. Любые дальнейшие решения я
принимал прежде всего, как инженер и создатель своей системы. Все мои вопросы были озвучены выше. Надеюсь на ваше
понимание.
Большое спасибо команде Авито Тех за интересный челлендж.
P.S Увидел, что вы изменили OpenAPI и убрали токены. Задачу я уже отправил, что делать, если у меня осталась старая
версия спецификации?
